<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="icon" href="/favicon.svg" type="image/svg+xml" />
		<link rel="manifest" href="/manifest.json" />
		<meta name="theme-color" content="#0D0D0D" />
		<script>
			// Self-healing script for PWA cache mismatches.
			// When a new version is deployed, the old cached HTML might try to load
			// JS files that no longer exist (they have new content hashes).
			// This script detects that and forces a clean reload.
			(function() {
				var RECOVERY_KEY = '__pwa_recovery__';
				var RECOVERY_TIMEOUT = 10000; // 10 seconds

				function shouldRecover() {
					// Prevent infinite recovery loops
					var lastRecovery = sessionStorage.getItem(RECOVERY_KEY);
					if (lastRecovery) {
						var elapsed = Date.now() - parseInt(lastRecovery, 10);
						if (elapsed < RECOVERY_TIMEOUT) {
							console.warn('PWA recovery attempted recently, skipping to prevent loop');
							return false;
						}
					}
					return true;
				}

				function recover() {
					if (!shouldRecover()) return;
					
					console.warn('App failed to load. Attempting recovery...');
					sessionStorage.setItem(RECOVERY_KEY, Date.now().toString());

					// Clear service worker caches and reload
					if ('caches' in window) {
						caches.keys().then(function(names) {
							return Promise.all(names.map(function(name) {
								return caches.delete(name);
							}));
						}).then(function() {
							window.location.reload();
						}).catch(function() {
							window.location.reload();
						});
					} else {
						window.location.reload();
					}
				}

				// Catch module loading failures (the main cause of white screens)
				window.addEventListener('error', function(e) {
					// Check if it's a script/module loading error
					if (e.target && (e.target.tagName === 'SCRIPT' || e.target.tagName === 'LINK')) {
						recover();
						return;
					}
					
					// Check error message for dynamic import failures
					var msg = (e.message || '').toLowerCase();
					if (msg.includes('failed to fetch dynamically imported module') ||
						msg.includes('importing a module script failed') ||
						msg.includes('failed to load module script')) {
						recover();
					}
				}, true);

				// Catch unhandled promise rejections from dynamic imports
				window.addEventListener('unhandledrejection', function(e) {
					var reason = String(e.reason || '').toLowerCase();
					if (reason.includes('failed to fetch dynamically imported module') ||
						reason.includes('loading chunk') ||
						reason.includes('loading css chunk')) {
						recover();
					}
				});
			})();
		</script>
		%sveltekit.head%
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents">%sveltekit.body%</div>
	</body>
</html>
